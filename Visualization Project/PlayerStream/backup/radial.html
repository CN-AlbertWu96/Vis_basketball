<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mercy Page</title>
    <script src="../jslib/d3.js"></script>
    <script src="../jslib/saveSvgAsPng.js"></script>
    <style>
    </style>
</head>

<body>

<svg>
    <defs>
    <!--<linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
    <stop offset="0%" style="stop-opacity:1" />
    <stop offset="50%" style="stop-opacity:0" />
    <stop offset="100%" style="stop-opacity:1" />
    </linearGradient> -->
    </defs>
</svg>

<script>
function max(a, b) { return a < b ? b : a }
function min(a, b) { return a < b ? a : b }

var innerRadius = 200
var outerRadius = 400
var width  = outerRadius * 2    //SVG绘制区域的宽度
var height = outerRadius * 2    //SVG绘制区域的高度

var svg = d3.select("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("transform", "translate(" + (width/2) +","+ (height/2) + ")")

function genSample(n, m) {
    var data = []
    var k = [50, 50, 50, 50, 50, 50, 50, 50, 50, 50]
    //var k = [10, 10, 10, 10, 10, 10, 10, 10, 10, 10]

    var i, j
    for (i = 0; i < n; i++) {
        data[i] = []
        data[i][0] = {x:0, y:0}
        for (j = 1; j < m; j++) {
            var y = data[i][j-1].y

            if (Math.random() * 100 < k[i])
                y += 8
            if (Math.random() * 100 < k[i])
                y -= 16 

            data[i][j] = {x: j, y: min(16, max(y, 2))}
        }
    }

    var k = 0
    for (j = 1; j < m; j++) {
        for (i = 0; i < n; i++) {
            data[i][j].y = data[i][j-1].y * k + data[i][j].y * (1-k)
        }
    }

    return data
}

function preprocess(data) {
    // calc max
    var i, j
    for (j = 0; j < data[0].length; j++) {
        ySum[j] = 0
        for (i = 0; i < data.length; i++) {
            ySum[j] += data[i][j].y
            yMax = max(data[i][j].y, yMax)
            ySumMax = max(ySumMax, ySum[j])
        }
    }
    color = d3.scaleOrdinal().range(d3.schemeCategory10)

    // sort to allocate color
    var plStat = []
    for (i = 0; i < data.length; i++) {
        var sum = 0
        for (j = 0; j < data[i].length; j++)
            sum += data[i][j].y
        plStat[i] = {i: i, sum: sum}
    }
    plStat.sort(function(a, b) { return a.sum < b.sum ? 1 : -1 })
    console.log(plStat)
    plStat.forEach(function(d, i) { color(d.i) })
}

function layout(data, gap) {
    ySumMax += gap * data.length

    for (j = 0; j < ySum.length; j++) {
        data[0][j].y0 = 0
        data[0][j].y1 = data[0][j].y0 + data[0][j].y
        for (i = 1; i < data.length; i++) {
            data[i][j].y0 = data[i-1][j].y1 + gap
            data[i][j].y1 = data[i][j].y0 + data[i][j].y
        }
    }
}

function fillColor(data) {
    console.log(yMax);
    var i, j
    var defs = d3.select("defs")
    var n = data.length, m = data[0].length
    var k = 0.4
    var scale = d3.scaleLog().domain([0.01, yMax]).range([50, 0])
    var opacityScale = d3.scaleLinear().domain([0.5, yMax]).range([0.2, 1])
    for (i = 0; i < n; i++) {
        var grad = defs.append("linearGradient")
                       .attr("x1", "0%")
                       .attr("y1", "0%")
                       .attr("x2", "100%")
                       .attr("y2", "0%")
                       .attr("id", "grad" + i)
        var opacity = 0.1
        var acc = 0
        for (j = 0; j < m; j++) {
            grad.append("stop")
                .attr("offset", (100.0 * j / (m - 1)) + "%")
                .style("stop-color", function() {
                    var cl = d3.hsl(d3.color(color(i)))
                    cl.s += 0.1
                    //cl.l += 0.1
                    return cl //d3.color(color(i))
                    //acc = k * acc + (1 - k) * data[i][j].y; 
                    //cl = d3.hsl(d3.color(color(i)))
                    //cl.h += acc / 0.3
                    //return cl
                })
                .style("stop-opacity", function() {
                    return 0.7
                    //now = opacityScale(data[i][j].y)
                    //opacity = k * opacity + (1 - k) * now
                    //return opacity
                })
        }
    }
}


var ySum = [], ySumMax = 0, yMax = 0 
var data = genSample(5, 12), color
preprocess(data)
layout(data, 1)
fillColor(data)

var xScale = d3.scaleLinear().domain(d3.extent(data[0],function(d){return d.x}))
                             .range([0, Math.PI * 2])
var yScale = d3.scaleLinear().domain([0, ySumMax])
                             .range([innerRadius, outerRadius])
 
var area = d3.radialArea()
             .angle(function(d) { return xScale(d.x) })
             .innerRadius(function(d) { return yScale(d.y0) })
             .outerRadius(function(d) { return yScale(d.y1) })
             .curve(d3.curveNatural)

svg.selectAll("path")
   .data(data).enter()
   .append("path")
   .attr("d", function(d) { return area(d) })
   .style("fill", function(d, i) { return "url(#grad" + i + ")"})

</script>
</body>
<script>
//saveSvgAsPng(document.getElementById("diagram"), "diagram.png", {scale:10});
</script>
</html>
