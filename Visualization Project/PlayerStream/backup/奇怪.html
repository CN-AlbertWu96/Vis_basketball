<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mercy Page</title>
    <script src="../jslib/d3.js"></script>
    <script src="../jslib/saveSvgAsPng.js"></script>
    <style>
    </style>
</head>

<body>

<svg>
    <defs>
    <!--<linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
    <stop offset="0%" style="stop-opacity:1" />
    <stop offset="50%" style="stop-opacity:0" />
    <stop offset="100%" style="stop-opacity:1" />
    </linearGradient> -->
    </defs>
</svg>

<script>
function max(a, b) { return a < b ? b : a }
function min(a, b) { return a < b ? a : b }

var width  = 1200;	//SVG绘制区域的宽度
var height = 500;	//SVG绘制区域的高度
var n = 8, m = 48

var svg = d3.select("svg")
            .attr("width", width)
            .attr("height", height)

function genSample(n, m) {
    var data = []
    var k = [50, 50, 50, 50, 50, 50, 50, 50, 50, 50]
    //var k = [10, 10, 10, 10, 10, 10, 10, 10, 10, 10]

    var i, j
    for (i = 0; i < n; i++) {
        data[i] = []
        data[i][0] = {x:0, y:5}
        for (j = 1; j < m; j++) {
            var y = data[i][j-1].y

            if (Math.random() * 100 < k[i])
                y += 8
            if (Math.random() * 100 < k[i])
                y -= 16 

            data[i][j] = {x: j, y: min(16, max(y, 2))}
        }
    }

    var k = 0.7
    for (j = 1; j < m; j++) {
        for (i = 0; i < n; i++) {
            data[i][j].y = data[i][j-1].y * k + data[i][j].y * (1-k)
        }
    }

    return data
}

data = genSample(n, m)

var ySum = [], ySumMax, yMax = 0 
var i, j
for (j = 0; j < data[0].length; j++) {
    ySum[j] = 0
    for (i = 0; i < data.length; i++) {
        ySum[j] += data[i][j].y
        yMax = max(data[i][j].y, yMax)
    }
}
ySumMax = d3.max(ySum)
var color = d3.scaleOrdinal().range(d3.schemeCategory10)

var plStat = []
for (i = 0; i < data.length; i++) {
    var sum = 0
    for (j = 0; j < data[i].length; j++)
        sum += data[i][j].y
    plStat[i] = {i: i, sum: sum}
}
plStat.sort(function(a, b) { return a.sum < b.sum ? 1 : -1 })
console.log(plStat)
plStat.forEach(function(d, i) { color(d.i) })

function layout(data, gap) {
    var base = []
    for (i = 0; i < ySum.length; i++) {
        base[i] = (ySumMax - ySum[i] - gap * (data.length - 1)) / 2
    }
    for (j = 0; j < ySum.length; j++) {
        data[0][j].y0 = base[j]
        data[0][j].y1 = data[0][j].y0 + data[0][j].y
        for (i = 1; i < data.length; i++) {
            data[i][j].y0 = data[i-1][j].y1 + gap
            data[i][j].y1 = data[i][j].y0 + data[i][j].y
        }
    }

    return ySumMax
}

function fillColor(data) {
    console.log(yMax);
    var i, j
    var defs = d3.select("defs")
    var n = data.length, m = data[0].length
    var k = 0.4
    var scale = d3.scaleLog().domain([0.01, yMax]).range([50, 0])
    var opacityScale = d3.scaleLinear().domain([0, yMax]).range([0.2, 1])
    for (i = 0; i < n; i++) {
        var grad = defs.append("linearGradient")
                       .attr("x1", "0%")
                       .attr("y1", "0%")
                       .attr("x2", "100%")
                       .attr("y2", "0%")
                       .attr("id", "grad" + i)
        var opacity = 0.1
        var acc = 0
        for (j = 0; j < m; j++) {
            grad.append("stop")
                .attr("offset", (100.0 * j / (m - 1)) + "%")
                .style("stop-color", function() {
                    return d3.color(color(i))
                })
                .style("stop-opacity", function() {
                    now = opacityScale(data[i][j].y)
                    opacity = k * opacity + (1 - k) * now
                    return opacity
                })
        }
    }
}

layout(data, 0.5)
fillColor(data)

var xScale = d3.scaleLinear().domain(d3.extent(data[0],function(d){return d.x}))
                             .range([40, width - 40])
var yScale = d3.scaleLinear().domain([0, ySumMax])
                             .range([height - 40, 40])
 
var area = d3.area()
             .x(function(d) { return xScale(d.x) })
             .y0(function(d) { return yScale(d.y0) })
             .y1(function(d) { return yScale(d.y1) })
             .curve(d3.curveCardinal)

svg.selectAll("path")
   .data(data).enter()
   .append("path")
   .attr("d", function(d) { return area(d) })
   .style("fill", function(d, i) { return "url(#grad" + i + ")"})

</script>
</body>

<script>
//saveSvgAsPng(document.getElementById("diagram"), "diagram.png", {scale:10});
</script>
</html>
