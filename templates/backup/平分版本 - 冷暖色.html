<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mercy Page</title>
    <script src="../jslib/d3.js"></script>
    <script src="../jslib/saveSvgAsPng.js"></script>
    <style>
    </style>
</head>

<body>

<svg>
    <defs>
    <!--<linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
    <stop offset="0%" style="stop-opacity:1" />
    <stop offset="50%" style="stop-opacity:0" />
    <stop offset="100%" style="stop-opacity:1" />
    </linearGradient> -->
    </defs>
</svg>

<script>
function max(a, b) { return a < b ? b : a }
function min(a, b) { return a < b ? a : b }

var width  = 1200;	//SVG绘制区域的宽度
var height = 500;	//SVG绘制区域的高度

var svg = d3.select("svg")
            .attr("width", width)
            .attr("height", height)

function genSample(n, m) {
    var data = []
    var k = [50, 50, 50, 50, 50, 50, 50, 50, 50, 50]
    //var k = [10, 10, 10, 10, 10, 10, 10, 10, 10, 10]

    var i, j
    for (i = 0; i < n; i++) {
        data[i] = []
        data[i][0] = {x:0, y:5}
        for (j = 1; j < m; j++) {
            var y = data[i][j-1].y

            if (Math.random() * 100 < k[i])
                y += 8
            if (Math.random() * 100 < k[i])
                y -= 16 

            data[i][j] = {x: j, y: min(16, max(y, 2))}
        }
    }

    var k = 0
    for (j = 1; j < m; j++) {
        for (i = 0; i < n; i++) {
            data[i][j].y = data[i][j-1].y * k + data[i][j].y * (1-k)
        }
    }

    return data
}

data = genSample(8, 12)

var ySum = [], ySumMax = [0, 0], yMax = 0 
var i, j
for (j = 0; j < data[0].length; j++) {
    ySum[j] = 0
    var halfSum
    for (i = 0; i < data.length; i++) {
        ySum[j] += data[i][j].y
        yMax = max(data[i][j].y, yMax)
        if (i == data.length/2 - 1) {
            ySumMax[0] = max(ySumMax[0], ySum[j])
            halfSum = ySum[j]
        } else if (i == data.length - 1) {
            ySumMax[1] = max(ySumMax[1], ySum[j] - halfSum)
        }
    }
}

console.log("ySumMax", ySumMax)
/*var d3c = d3.schemeCategory20c
var colorScheme = 
[d3c[3], d3c[8+3], d3c[3], d3c[8+3], d3c[6], d3c[6], d3c[6], d3c[6]]*/

var d3c = d3.schemeCategory10
var colorScheme = 
[d3c[0], d3c[0], d3c[0], d3c[0], d3c[1], d3c[1], d3c[1], d3c[1]]

var color = d3.scaleOrdinal().range(
        //colorScheme
        //d3.schemeCategory10
        d3.schemeCategory20c
        )

var plStat = []
for (i = 0; i < data.length; i++) {
    var sum = 0
    for (j = 0; j < data[i].length; j++)
        sum += data[i][j].y
    plStat[i] = {i: i, sum: sum}
}
plStat.sort(function(a, b) { return a.sum < b.sum ? 1 : -1 })
console.log(plStat)
//plStat.forEach(function(d, i) { color(d.i) })

function layout(data, gap) {
    base = []
    ySumMax[0] += gap * data.length / 2
    ySumMax[1] += gap * data.length / 2
    for (i = 0; i < ySum.length; i++) {
        base[i] = ySumMax[1]
    }

    var halfLen = data.length / 2
    for (j = 0; j < ySum.length; j++) {
        data[0][j].y0 = base[j] + gap * 2
        data[0][j].y1 = data[0][j].y0 + data[0][j].y
        for (i = 1; i < halfLen; i++) {
            data[i][j].y0 = data[i-1][j].y1 + gap
            data[i][j].y1 = data[i][j].y0 + data[i][j].y
        }
        data[halfLen][j].y0 = base[j] - gap * 2
        data[halfLen][j].y1 = data[halfLen][j].y0 - data[halfLen][j].y
        for (i = halfLen + 1; i < data.length; i++) {
            data[i][j].y0 = data[i-1][j].y1 - gap
            data[i][j].y1 = data[i][j].y0 - data[i][j].y
        }
    }

    /*for (j = 0; j < ySum.length; j++) {
        data[0][j].y0 = base[j]
        data[0][j].y1 = data[0][j].y0 + data[0][j].y
        for (i = 1; i < data.length; i++) {
            data[i][j].y0 = data[i-1][j].y1 + gap
            data[i][j].y1 = data[i][j].y0 + data[i][j].y
        }
    }*/
}

function fillColor(data) {
    console.log(yMax);
    var i, j
    var defs = d3.select("defs")
    var n = data.length, m = data[0].length
    var k = 0.2
    var scale = d3.scaleLog().domain([0.01, yMax]).range([50, 0])
    var opacityScale = d3.scaleLog().domain([0.5, yMax]).range([1, 1])
    var lightScale = d3.scaleLinear().domain([4, yMax]).range([0.8, 0.5])
    for (i = 0; i < n; i++) {
        var grad = defs.append("linearGradient")
                       .attr("x1", "0%")
                       .attr("y1", "0%")
                       .attr("x2", "100%")
                       .attr("y2", "0%")
                       .attr("id", "grad" + i)
        var opacity = 0.1
        var acc = 0
        for (j = 0; j < m; j++) {
            grad.append("stop")
                .attr("offset", (100.0 * j / (m - 1)) + "%")
                .style("stop-color", function() {
                    var cl = d3.hsl(d3.color(color(i)))
                    cl.l = lightScale(data[i][j].y)
                    return cl
                    //acc = k * acc + (1 - k) * data[i][j].y; 
                    //cl = d3.hsl(d3.color(color(i)))
                    //cl.h += acc / 0.3
                    //return cl
                })
                .style("stop-opacity", function() {
                    now = opacityScale(data[i][j].y)
                    opacity = k * opacity + (1 - k) * now
                    return 1 //opacity
                })
        }
    }
}

layout(data, 1)
fillColor(data)

var xScale = d3.scaleLinear().domain(d3.extent(data[0],function(d){return d.x}))
                             .range([40, width - 40])
var yScale = d3.scaleLinear().domain([0, ySumMax[0] + ySumMax[1]])
                             .range([height - 40, 40])
 
var area = d3.area()
             .x(function(d) { return xScale(d.x) })
             .y0(function(d) { return yScale(d.y0) })
             .y1(function(d) { return yScale(d.y1) })
             .curve(d3.curveNatural)

svg.selectAll("path")
   .data(data).enter()
   .append("path")
   .attr("d", function(d) { return area(d) })
   .style("fill", function(d, i) { return "url(#grad" + i + ")"})

/*svg.append("line")
   .attr("x1", 40)
   .attr("y1", yScale(base[0]))
   .attr("x2", width - 40)
   .attr("y2", yScale(base[0]))
   .attr("stroke", "black")
   .attr("stroke-width", "2px")*/

</script>
</body>

<script>
//saveSvgAsPng(document.getElementById("diagram"), "diagram.png", {scale:10});
</script>
</html>
